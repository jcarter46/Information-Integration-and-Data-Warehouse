<html>
<head>

<script src="mrdoob-three.js-46c0a84\build\Three.js"></script>
<script src="jquery-1.7.2.min.js"></script>
<script src="jqueryFileTree/jqueryFileTree.js"></script>
<link href="jqueryFileTree/jqueryFileTree.css" rel="stylesheet" type="text/css" media="screen" />

<link href="styles.css" rel="stylesheet" type="text/css" media="screen" />

<script type="text/javascript">
//By Chris Lenk for UTC REU 2012
//Don't forget to set variable 'root' in the PHP connector script

    $(document).ready( function() {
        
        $('#filepick').fileTree({ root: 'fall_detection/', script: 'jqueryFileTree/connectors/jqueryFileTree.php', multiFolder: false }, function(file) { 
            animFile = file;
            loadAnim();
        }, false); //False to show folders AND files
        
    });
</script>

<script type="text/javascript">
    var camera;
    var scene;
    var renderer;
    var camCntrl;
    //Dimensions
    var width = 600;
    var height = 500;
    //Camera variables
    var view_angle = 45;
    var aspect = width / height;
    var near = 0.1;
    var far = 10000;

    var person;
    var clock = new THREE.Clock();

    var animFile = 'fall_detection/INACTIVE.js';

    //Keys
    ROT = 90;
    ZOOM = 88;
    PAN = 67;

    FPS = 12;
    var BLENDERSCALE = 15;
    var halt = false; //True stops the animation
    var animOffset = 0; //Starting morphTarget in the animation
    var duration = 1667; //in ms
    var keyframes = 40;
    var interpolation = duration / keyframes;
    var lastKeyframe = 0;
    var currentKeyframe = 0;

    var humanAvgWalkSpeed = 1.3;
    var steps = 0;
    var dist = 0;
    var speed = 800;

    //Initializes the scene
    function init() {
        //Get canvas container
        var canvas = document.getElementById("container");

        //Create and start the renderer and add it to the canvas
        renderer = new THREE.WebGLRenderer( {antialias: true} );
        renderer.setSize(width, height);
        renderer.shadowMapEnabled = true; //Turn on shadows
        renderer.shadowMapSoft = true; //Anti-aliasing
        canvas.appendChild(renderer.domElement);
        
        //Create camera and scene
        scene = new THREE.Scene();
        addCamera();

        //Disable text cursor on the canvas
        canvas.onselectstart = function() {
            return false;
        }

        //Add stuff to the scene
        addObjs(scene);
        addLights(scene);
        
        //Draw it
        renderer.setClearColorHex(0x000000, 1.0);
        renderer.clear(); //Sets the background color
        renderer.render(scene, camera);

        //Set up the keys to speed up/down the walking speed
        document.addEventListener("keydown", speedAdjust, false);
        
        //kickstart animation
        animate();
    }

    //Puts the camera back at the starting position
    function resetCam(e) {
        if (e.keyCode == 32) { //Spacebar
            scene.remove(camera);
            addCamera();
        }
    }

    function addCamera() {
        camera = new THREE.PerspectiveCamera( view_angle, aspect, near, far );
        scene.add(camera);
        //Pull camera back from its original starting point of (0,0,0)
        //camera.position.set(200,300,600);
        //camera.position.set(100,00,500);
        camera.position.set(360,-55,575);

        //Controls to move the camera
        camCntrl = new THREE.TrackballControls(camera, renderer.domElement);
        camCntrl.keys = [ROT, ZOOM, PAN]; //rotate, zoom, pan

        //Reset the camera when spacebar pressed
        document.addEventListener("keydown", resetCam, false);
    }

    function addLights() {
        //Create a spot light for shadows and add it
        var spotLight = new THREE.SpotLight(0xFFFFFF);
        spotLight.position.set(300,300,400);
        spotLight.castShadow = true;
        //spotLight.shadowCameraVisible = true;
        scene.add(spotLight);

        //Directional light
        var frontLight = new THREE.DirectionalLight(0xFFFFFF);
        frontLight.position.set(400,-900,200);
        //frontLight.castShadow = true;
        scene.add(frontLight);

        var frontLight = new THREE.DirectionalLight(0xFFFFFF);
        frontLight.position.set(0,0,0);
        scene.add(frontLight);

        //Ambient lighting
        var ambLight = new THREE.AmbientLight(0xFFFFFF);
        scene.add(ambLight);
    }

    function getActivityName( name ) {
        switch (name) {
            case 'INACTIVE':
                return 'No Activity';
                break;
            case 'ADL_Bending':
                return 'ADL - Bending';
                break;
            case 'ADL_Cough':
                return 'ADL - Coughing or Sneezing';
                break;
            case 'ADL_Jogging':
                return 'ADL - Jogging';
                break;
            case 'ADL_Sitting':
                return 'ADL - Sitting';
                break;
            case 'ADL_Squat':
                return 'ADL - Squatting';
                break;
            case 'ADL_WalkingForward':
                return 'ADL - Walking Forwards';
                break;
            case 'Fall_BackLeft':
                return 'Falling - Backwards, to the Left';
                break;
            case 'Fall_BackLying':
                return 'Falling - Backwards, Lying';
                break;
            case 'Fall_BackRight':
                return 'Falling - Backwards, to the Right';
                break;
            case 'Fall_BackSitting':
                return 'Falling - Backwards, Sitting';
                break;
            case 'Fall_FrontKnees':
                return 'Falling - Forewards, onto Knees';
                break;
            case 'Fall_FrontLeft':
                return 'Falling - Forewards, to the Left';
                break;
            case 'Fall_FrontLying':
                return 'Falling - Forewards, Lying';
                break;
            case 'Fall_FrontLyingProtect':
                return 'Falling - Forewards, Lying, Protected';
                break;
            case 'Fall_FrontRight':
                return 'Falling - Forewards, to the Right';
                break;
            case 'Fall_Rolling':
                return 'Falling - Rolling';
                break;
            case 'Fall_SidewayLeft':
                return 'Falling - Sideways, to the Left';
                break;
            case 'Fall_SidewayRight':
                return 'Falling - Sideways, to the Right';
                break;
        }
    }

    function addObjs() {
        var f = animFile.replace(/^.*[\\\/]/, '');
        f = f.replace(/.js/, '');
        f = getActivityName(f);
        $('#activity').html(f);
        var loader = new THREE.JSONLoader(true);
        loader.load ( animFile, function (geometry) {
            var material = geometry.materials[ 0 ];
            material.morphTargets = true;

            person = new THREE.MorphAnimMesh( geometry, new THREE.MeshFaceMaterial() );
            person.scale.set(BLENDERSCALE, BLENDERSCALE, BLENDERSCALE);
            person.overdraw = true;
            person.castShadow = true;
            person.receiveShadow = true;
            scene.add(person);
        } );
    }

    //loads the currently selected animation
    function loadAnim() {
        halt = true;
        scene.remove(person);
        addObjs();
        halt = false;
    }

    //Animation Loop
    function animate() {
        var delta = clock.getDelta();

        //Update person to correct keyframe
        if (person) {
            person.updateAnimation( speed * delta );
            //$('#distTraveled').html(person.currentKeyframe);
            
            //Update number of steps taken
                    /*Need to know on which keyframes the model makes a footstep
                    Keyframes in Three.js start from 0 but in Blender from 1*/
            //Assume the footsteps are on the first frame and the middle frame (first one foot and then the other)
            /*if (person.currentKeyframe == 0 || person.currentKeyframe == (person.length / 2) - 1) {
                steps++;
                $('#numSteps').html(steps);
            }*/
        }

        //Update the view
        camCntrl.update();
        camera.lookAt(scene.position);
        renderer.render(scene, camera);
        if (!halt) {
            window.requestAnimationFrame(animate, renderer.domElement);
        }
    }

    function speedAdjust(e) {
        if (e.keyCode == 38 && speed < 5000) { //Up Arrow
            speed += 100;
        } else if (e.keyCode == 40 && speed > 0) { //Down Arrow
            speed -= 100;
        }
    }

</script>


</head>


<body onLoad="init()">

<div id="overlay">
    <p>Activity: <span id="activity">0</span></p>
</div>

<div class="example">
    <div id="filepick" class='demo'></div>
</div>

<div id="container"></div>

<p>Click and drag to move camera. Hold <b>Z</b> to rotate, <b>X</b> to zoom, or <b>C</b> to pan.</p>

<p>Uses a model created using <a href="http://wiki.blender.org/index.php/Doc:2.4/Tutorials/Animation/BSoD/Character_Animation">this tutorial</a>.</p>

</body>
</html>